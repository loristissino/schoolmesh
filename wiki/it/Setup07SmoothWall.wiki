#summary Integrazione con SmoothWall
#labels Phase-Deploy

= Integrazione con !SmoothWall =

Per l'abilitazione/disabilitazione dell'accesso a Internet !SchoolMesh si basa su dei comandi da dare ad una macchina Linux che funziona da firewall e proxy server.

La documentazione che segue riguarda !SmoothWall, ma dovrebbe essere facilmente adattabile anche ad altri tipi di distribuzioni Linux, visto che si basa su semplici comandi iptables.

== Aggiunta delle chiavi di autorizzazione ==

Fare in modo che l'utente www-data (server web sotto cui funziona l'applicazione !SchoolMesh) possa eseguire i comandi dell'utente `root` della macchina SmoothWall, attraverso l'aggiunta delle chiavi di autorizzazione, agendo sul file `/root/.ssh/authorized_keys`.

Fondamentalmente, creare una directory per le chiavi di www-data e generare le stesse:

{{{
sudo mkdir /var/www/.ssh
sudo chown www-data /var/www/.ssh
sudo -u www-data ssh-keygen -t rsa

}}}

Poi, copiare la chiave pubblica di www-data sul server !SmoothWall e aggiungerla alle `authorized_keys`:

{{{
scp -P 222 /var/www/.ssh/id_rsa.pub root@192.168.0.100:/tmp/www-data-key

}}}

e, sul server !SmoothWall:

{{{
cat /tmp/www-data-key >> /root/.ssh/authorized_keys

}}}

== Autorizzazione all'esecuzione con _at_ ==

È necessario fare in modo che l'utente www-data possa eseguire operazioni temporizzate. Per farlo, è necessario eliminare la voce www-data dal file `/etc/at.deny`.

== Personalizzazione di SmoothWall ==

Creare, sulla macchina SmoothWall, due directory per contenere gli script e i file personalizzati di SchoolMesh:

{{{
mkdir /etc/schoolmesh /root/schoolmesh

}}}

Copiare via scp dalla directory `utilities/smoothwall` di SchoolMesh, il file dello script da eseguire all'avvio e quello di configurazione nelle apposite directory, appena create.

Modificare il file di configurazione `/etc/schoolmesh/schoolmesh_iptables.rc` indicando gli indirizzi IP da cui accettare sempre le connessioni, nonché la regola di default da seguire per i casi di connessione bloccata.

{{{
#/bin/bash

ALWAYS_ACCEPTED="192.168.0.121 192.168.1.105 192.168.0.122 192.168.0.123 192.168.11.1 192.168.11.2 192.168.11.3 192.168.11.4"
# Connections from these hosts will be always accepted

DEFAULT_CONDITION="-p tcp -s 192.168.0.0/16 --dport 800"
# We will filter packets with these characteristics:
# - the source is in the LAN
# - the destination port is 800 (standard for smoothwall proxy)

DEFAULT_RULE="DNAT --to-destination 172.16.200.254:80"
# This is a kind of general policy used on basic chains.
# When a connection is refused, we'll change the destination address 
# to another machine connected directly to the firewall
# (in this case, the internal IP address of the router is chosen)

COMMENT="schoolmeshrule default"

ACCEPT_RULE="RETURN"

CHAIN=schoolmesh
TABLE=nat
BASICCHAIN=PREROUTING

}}}

== Esecuzione automatica dello script all'avvio della macchina ==

Per fare in modo che il comando descritto precedentemente venga eseguito all'avvio della macchina SmoothWall, aggiungere la riga

{{{
/root/schoolmesh/schoolmesh_iptables

}}}

alla fine del file `/etc/rc.d/rc.sysinit` (ovviamente il percorso da indicare dovrà corrispondere a quello dello script predisposto).




