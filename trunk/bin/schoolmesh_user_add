#!/bin/bash

if [ $# -eq 0 ] ; then
	echo "This script is a wrapper. See schoolmesh(1) for details."
	exit 1
fi
	
USERNAME=$1
HOMEDIR=$2
GROUP=$3
FULLNAME=$4
	
if [ ! -d "$HOMEDIR" ] ; then
	echo "Not a directory: $HOMEDIR"
	exit 2
fi

if [ -e "$HOMEDIR/$USERNAME" ] ; then
	echo "File exists: $HOMEDIR/$USERNAME"
	exit 3
fi

getent passwd $USERNAME > /dev/null

if [ $? -eq 0 ] ; then
	echo "Already a user: $USERNAME"
	exit 5
fi

getent group $GROUP > /dev/null

if [ $? -ne 0 ] ; then
	echo "Not a group: $GROUP"
	exit 6
fi

if [ -z "$FULLNAME" ] ; then
	echo "Missing fullname"
	exit 7
fi

sudo useradd -d "$HOMEDIR/$USERNAME" -g $GROUP -c "$FULLNAME" $USERNAME -s /bin/false && echo "added user $USERNAME"
sudo mkdir -v "$HOMEDIR/$USERNAME"
sudo chown -v $USERNAME:root "$HOMEDIR/$USERNAME"
sudo chmod -v 711 "$HOMEDIR/$USERNAME"


