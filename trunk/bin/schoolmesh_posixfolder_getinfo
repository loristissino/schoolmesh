#!/bin/bash

CONFIG_READ=0
source /var/schoolmesh/config/schoolmesh.rc $@
if [ $CONFIG_READ -ne 1 ]; then echo "Error in reading configuration"; exit 1; fi

#@ # NAME
#@
#@ {} - Get info about a posix user's folder's contents
#@
#@ # SYNOPSIS
#@
#@ {} *username* path *directoryname*
#@ {} *username* list *directoryname*
#@
#@ # DESCRIPTION
#@
#@ This script generates a list of pairs *key=value* about a posix folder.
#@ The user must exist.
#@ 
#@ # WARNINGS
#@
#@ The user who runs this (typically, www-data or apache) must be allowed
#@ to run commands on behalf of other users (through sudo).
#@
#@ # EXAMPLES
#@
#@	{-} john.test path '/'  
#@	{-} john.test list 'mydocs' 

USERNAME=$1
COMMAND=$2
BASEDIRNAME=$3
DIRECTORYNAME="$POSIX_HOMEDIR_USERS/$USERNAME$BASEDIRNAME"

if [ $BASEDIRNAME = '/' ]; then
	SUBSTITUTION="$POSIX_HOMEDIR_USERS/$USERNAME$BASEDIRNAME"
else
	SUBSTITUTION="$POSIX_HOMEDIR_USERS/$USERNAME$BASEDIRNAME/"
fi

checkUsername $USERNAME
checkOneOf $COMMAND path list

sudo /usr/bin/test -d "$DIRECTORYNAME"

if [[ $? -ne 0 ]]; then
	msg_failed 'Not a directory'
	exit 23
fi

TEMPFILE=$(mktemp)

case $COMMAND in
	path)
		echo found=1
		;;
	list)
		LANG=C sudo -u $USERNAME /usr/bin/find -L "$DIRECTORYNAME" -maxdepth 1 -mindepth 1 > $TEMPFILE
		IFS=$'\n'
		for FILE in $(cat $TEMPFILE)
			do
				INFO=$(LANG=C sudo -u $USERNAME /usr/bin/stat "$FILE" -c 'FILE%i=%F:%s:%Y:%n' -L | sed "s|$SUBSTITUTION||g")
				FILETYPE=$(LANG=C sudo -u $USERNAME /usr/bin/file "$FILE" --mime-type -L | sed 's/.*: //')
				
				echo "$INFO:$FILETYPE"
			done
		;;
esac

rm $TEMPFILE
