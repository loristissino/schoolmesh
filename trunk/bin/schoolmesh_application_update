#!/bin/bash

CONFIG_READ=0
source /var/schoolmesh/config/schoolmesh.rc $@
if [ $CONFIG_READ -ne 1 ]; then echo "Error in reading configuration"; exit 1; fi

#@ # NAME
#@
#@ {} - Update the application with the newest SVN release
#@
#@ # SYNOPSIS
#@
#@ {} prod | dev | test
#@
#@ # DESCRIPTION
#@
#@ This script updates the application, making a backup of specific configuraton files that
#@ might have been customized, and restoring them afterwards.
#@ 
#@ # WARNINGS
#@ 
#@ This script does not backup the database. It's better to run _schoolmesh\_application\_dumptables(8)_ before its use.
#@ 
#@ The list of customizable files to backup might be incomplete.
#@
#@ Run at your own risk. New versions may introduce regressions.
#@
#@ # EXAMPLES
#@
#@	{-} prod

ENVIR=$1

checkOneOf $ENVIR dev prod test

SCHOOLMESHDIR=/var/schoolmesh
SCHOOLMESHDIRSVN=/var/schoolmeshsvn

cd $SCHOOLMESHDIRSVN

echo -n "Starting svn update... "

svn update --accept theirs-full --non-interactive

msg_ok "done."

schoolmesh_application_setstate disabled $ENVIR

sudo rsync -avz --exclude '.svn' --progress $SCHOOLMESHDIRSVN/* $SCHOOLMESHDIR

cd $SCHOOLMESHDIR

TODAY=$(date +%Y-%m-%d-%H%M%S)
echo $TODAY

BACKUPDIR=/etc/schoolmesh/$TODAY

FILELIST="config/databases.yml config/schoolmesh.rc apps/frontend/config/app.yml apps/backend/config/app.yml"

sudo mkdir $BACKUPDIR
sudo mkdir -p $BACKUPDIR/{config,apps/frontend/config,apps/backend/config}

echo -n "Starting backup of configuration files... "

for FILE in $FILELIST
	do
		sudo cp -v $FILE "$BACKUPDIR/$FILE" || msg_failed "File $FILE not found"
	done

msg_ok "done."



echo -n "Restoring configuration files... "
for FILE in $FILELIST
	do
		sudo cp -v "$BACKUPDIR/$FILE" $FILE || msg_failed "File $FILE not found"
	done

msg_ok "done."

echo -n "Setting correct owner... "
sudo find $SCHOOLMESHDIR ! -user www-data -exec chown -R www-data:adm {} \;
msg_ok "done."

echo -n "Applying correct permissions to files... "
sudo find $SCHOOLMESHDIR -type f ! -perm 660 -exec chmod 660 {} \;
msg_ok "done."

echo -n "Applying correct permissions to directories... "
sudo find $SCHOOLMESHDIR -type d ! -perm 770 -exec chmod 770 {} \;
msg_ok "done."


echo -n "Cleaning the cache... "
sudo -u www-data symfony cc
msg_ok "done."

echo -n "Copying man pages... "
for i in 1 8
  do
    sudo cp -v doc/man/man$i/* /usr/local/share/man/man$i/ 2>/dev/null
	sudo chmod +r /usr/local/share/man/man$i/*
  done
msg_ok "done."

echo -n "Copying scripts... "
sudo cp  bin/schoolmesh* /usr/local/bin
sudo chown root:root /usr/local/bin/schoolmesh*
sudo chmod 755 /usr/local/bin/schoolmesh*

msg_ok "done."

sudo chmod +x /var/schoolmesh/symfony

schoolmesh_application_setstate enabled $ENVIR

