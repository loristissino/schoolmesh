#!/bin/bash

CONFIG_READ=0
source /var/schoolmesh/config/schoolmesh.rc $@
if [ $CONFIG_READ -ne 1 ]; then echo "Error in reading configuration"; exit 1; fi

#@ # NAME
#@
#@ {} - Disable Internet access for a workstation, and remove all its scheduled jobs 
#@
#@ # SYNOPSIS
#@
#@ {} *ipaddress*
#@
#@ # DESCRIPTION
#@
#@ This script disable Internet access for a workstation, and removes all its
#@ scheduled jobs. It is used before applying new rules, in order to reset the
#@ original "blank" conditions.
#@
#@ # EXAMPLES
#@
#@	{-} 192.168.1.3

IPADDRESS=$1
REQUESTER=$2

checkString $IPADDRESS
checkString $REQUESTER

COMMAND="iptables -D $FIREWALL_CHAIN -s $IPADDRESS -j ACCEPT -m comment --comment \"$FIREWALL_COMMENT $REQUESTER\""

echo $COMMAND

ssh -p $FIREWALL_SSH_PORT $FIREWALL_SSH_USER@$FIREWALL_ADDRESS "$COMMAND" 2>/dev/null

schoolmesh_workstations_getjobs go | grep "=$IPADDRESS," | cut -d '=' -f1 | xargs -i atrm {}

exit 0
