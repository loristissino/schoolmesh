#!/bin/bash

CONFIG_READ=0
source /var/schoolmesh/config/schoolmesh.rc $@
if [ $CONFIG_READ -ne 1 ]; then echo "Error in reading configuration"; exit 1; fi

#@ # NAME
#@
#@ {} - Ask for registration of logon or logoff of a user in schoolmesh db
#@
#@ # SYNOPSIS
#@
#@ {} [logon|logoff] *username* *machinename* *ip*
#@
#@ # DESCRIPTION
#@
#@ This script is used from samba to ask for the registration of logons
#@ and logoffs of users from the local network.
#@ Edit your smb.conf adding these lines in [homes] section:
#@
#@     [homes]
#@      ...
#@      preexec = schoolmesh_sambaaccounts_log logon %U %M %m
#@      postexec = schoolmesh_sambaaccounts_log logon %U %M %m
#@
#@ # EXAMPLES
#@
#@ {-} logon john.doe pc13labinf3 192.168.3.13
#@ {-} logoff john.doe pc13labinf3 192.168.3.13

ACTION=$1
checkOneOf $ACTION logon logoff
USERNAME=$2
checkString $USERNAME
MACHINE=$3
checkString $MACHINE
IP=$4
checkString $IP

OUTPUT=$(mktemp)

POSTDATA="check="$(echo -n $USERNAME$IP$MACHINE$SCHOOLMESH_TOKEN | md5sum | gawk '{ print $1 }')
wget --post-data $POSTDATA $SCHOOLMESH_SERVER/lan$ACTION/username/$USERNAME/ip/$IP/workstation/$MACHINE -O $OUTPUT

echo $POSTDATA

grep "schoolmesh_result SUCCESS" $OUTPUT

if [[ $? -eq 0 ]]; then
  msg_ok "$ACTION registered"
  exit 0
else
  msg_failed "$ACTION not registered"
  grep "schoolmesh_result ERROR" $OUTPUT
  exit 2
fi

unexpectedError $@


